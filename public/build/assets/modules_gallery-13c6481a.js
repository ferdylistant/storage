async function t(){if(!window.GLightbox&&(await async function(t){return new Promise((e,n)=>{if(document.querySelector(`script[src="${t}"]`))return void e();const o=document.createElement("script");o.src=t,o.async=!0,o.onload=()=>e(),o.onerror=()=>n(new Error(`Failed to load script: ${t}`)),document.head.appendChild(o)})}("https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"),!document.querySelector('link[href*="glightbox.min.css"]'))){const t=document.createElement("link");t.rel="stylesheet",t.href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css",document.head.appendChild(t)}}async function e(e,n){const o=document.getElementById("moments");if(!o)return;const i=window.location.pathname.split("/").filter(Boolean),a=i.length>1&&"moments"===i[0]?i[1]:null;let r=[],l=null,s=null;const c=function(t,e){return debounce(()=>{"function"==typeof t&&t(),"function"==typeof e&&e()},150)}(e,n),d=()=>{requestAnimationFrame(()=>setTimeout(c,80))};function u(t,e,n={}){const o=document.getElementById(t);if(!o)return;const i=o.clientWidth,a=n.spacing??8,r=n.rowHeight??200;let s=[],c=0;const u=[];function m(){if(!s.length)return;const t=s.reduce((t,e)=>t+e.aspectRatio,0),e=(i-a*(s.length-1))/t,n=s.map((t,n)=>{const o=e*t.aspectRatio,i=e,r=n===s.length-1?0:a;return`\n                        <a href="${t.src}" class="gallery-item glightbox" data-gallery="album-${l}" data-title="${t.title??"Untitled"}"\n                           style="flex: 0 0 ${o}px; height: ${i}px; margin-right: ${r}px;">\n                            <img src="${t.srct}" alt="${t.title??""}"/>\n                        </a>`}).join("");u.push(`<div class="gallery-row">${n}</div>`),s=[],c=0}for(const l of e){const t=r*l.aspectRatio;c+t+a*s.length>i&&m(),s.push(l),c+=t}m(),requestAnimationFrame(()=>{o.innerHTML=u.join("");o.querySelectorAll(".gallery-item").forEach((t,e)=>{setTimeout(()=>t.classList.add("show"),50*e)}),d()})}async function m(){try{const t=await fetch("/tab/moments",{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!t.ok)throw new Error("Failed to load albums");const e=await t.json();o.innerHTML=e.html,document.querySelectorAll(".album-item").forEach(t=>{t.addEventListener("click",async()=>{const e=t.getAttribute("data-album-slug");history.pushState(null,"",`/moments/${e}`),await h(e)})}),d(),l=null,r=[]}catch(t){o.innerHTML='<div class="alert alert-danger text-center">Failed to load albums.</div>'}}async function h(e){try{const n=await fetch(`/tab/moments/${e}`,{headers:{"X-Requested-With":"XMLHttpRequest"}});if(!n.ok)throw new Error("Failed to load album photos");const i=await n.json();o.innerHTML=i.html,l=e,await function(t){const e=t.querySelectorAll("img");return Promise.all(Array.from(e).map(t=>t.complete&&0!==t.naturalHeight?Promise.resolve():new Promise(e=>{t.onload=e,t.onerror=e})))}(o),r=Array.from(o.querySelectorAll("a.gallery-item")).map(t=>{const e=t.querySelector("img");return{src:t.href,srct:e.src,title:t.getAttribute("data-title"),aspectRatio:e.naturalWidth/e.naturalHeight}}),u("my_glightbox_gallery",r),await t(),s&&"function"==typeof s.destroy&&s.destroy(),setTimeout(()=>{s=GLightbox({selector:".glightbox"})},80)}catch(n){o.innerHTML='<div class="alert alert-danger text-center">Failed to load photos.</div>'}}o.addEventListener("click",async t=>{("backToAlbums"===t.target.id||t.target.closest("#backToAlbums"))&&(history.pushState(null,"","/moments"),await m())}),a?await h(a):await m();const g=async()=>{const t=window.location.pathname.split("/").filter(Boolean),e=t.length>1&&"moments"===t[0]?t[1]:null;e?await h(e):await m()};window.removeEventListener("popstate",g),window.addEventListener("popstate",g);const p=debounce(()=>{r.length&&l&&u("my_glightbox_gallery",r)},200);window.removeEventListener("resize",p),window.addEventListener("resize",p)}export{e as initGallery};
